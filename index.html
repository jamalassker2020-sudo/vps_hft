<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HFT Ultra MT5 - Valetax Live</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0e14;--card:#121820;--border:#1a2030;--txt:#c8d0dc;--dim:#5a6270;--g:#0f6;--r:#f44;--b:#0af;--y:#fc0}
        html.light{--bg:#f4f6f8;--card:#fff;--border:#dde;--txt:#1a1a2e;--dim:#888}
        body{background:var(--bg);color:var(--txt);font:11px/1.4 monospace;padding:8px;min-height:100vh}
        .g{color:var(--g)}.r{color:var(--r)}.b{color:var(--b)}.y{color:var(--y)}.dim{color:var(--dim)}
        .card{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:8px;margin-bottom:8px}
        .row{display:flex;gap:8px;flex-wrap:wrap}
        .col{flex:1;min-width:120px}
        .grid{display:grid;gap:4px}
        .g6{grid-template-columns:repeat(6,1fr)}
        .stat{background:var(--bg);padding:6px;border-radius:3px;text-align:center}
        .stat small{display:block;font-size:9px;color:var(--dim);margin-bottom:2px}
        .stat b{font-size:13px}
        h1{font-size:14px;margin-bottom:4px}
        table{width:100%;border-collapse:collapse;font-size:10px}
        th,td{padding:4px;text-align:right}
        th{color:var(--dim);font-weight:400;border-bottom:1px solid var(--border)}
        td:first-child,th:first-child{text-align:left}
        .scroll{max-height:200px;overflow-y:auto}
        .log{font-size:9px;padding:2px 4px;margin:1px 0;border-radius:2px;background:var(--bg)}
        button{background:var(--card);border:1px solid var(--border);color:var(--txt);padding:4px 8px;border-radius:3px;cursor:pointer;font:inherit}
        .pulse{animation:p 1.5s infinite}@keyframes p{50%{opacity:.5}}
        .badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:9px}
        .badge.on{background:#0f62;color:var(--g)}.badge.off{background:#f442;color:var(--r)}.badge.warn{background:#fc02;color:var(--y)}
        input[type="text"]{background:var(--bg);border:1px solid var(--border);color:var(--txt);padding:4px 8px;border-radius:3px;font:inherit;width:100%}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100}
        .modal{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;width:90%;max-width:400px}
    </style>
</head>
<body>
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
            <h1>‚ö° HFT FX-ULTRA <span class="dim">2026</span></h1>
            <small class="dim">VALETAX LIVE ‚Ä¢ 641086382 ‚Ä¢ FOREX & GOLD ‚Ä¢ MT5 WEBHOOK</small>
        </div>
        <div class="row" style="gap:4px">
            <span id="status" class="badge pulse">INIT</span>
            <span id="api" class="badge dim">DATA:--</span>
            <span id="webhook" class="badge dim">WH:--</span>
            <button onclick="showWebhookConfig()">‚öôÔ∏è</button>
            <button onclick="reset()">‚ü≤</button>
        </div>
    </div>

    <div class="grid g6" style="margin-bottom:8px">
        <div class="stat"><small>üí∞ EQUITY</small><b id="equity" class="g">$0.00</b></div>
        <div class="stat"><small>TRADES</small><b id="trades" class="b">0</b></div>
        <div class="stat"><small>WIN%</small><b id="winrate" class="y">0%</b></div>
        <div class="stat"><small>OPEN</small><b id="openPos" class="b">0/6</b></div>
        <div class="stat"><small>LOT</small><b id="curLot" class="g">0.01</b></div>
        <div class="stat"><small>SERVER</small><b style="font-size:9px">VALETAX-L3</b></div>
    </div>

    <div class="row">
        <div class="col" style="flex:3">
            <div class="card">
                <div class="row" style="justify-content:space-between;margin-bottom:4px"><b class="b">üìä FX MARKET</b><span id="time" class="dim">--:--:--</span></div>
                <div class="scroll"><table><thead><tr><th>SYMBOL</th><th>BID</th><th>ASK</th><th>SPREAD</th><th>RSI</th><th>SIGNAL</th></tr></thead><tbody id="market"></tbody></table></div>
            </div>
        </div>
        <div class="col">
            <div class="card"><b>üìà MT5 POSITIONS</b><div id="positions" class="scroll"></div></div>
            <div class="card"><b>‚ö° LOG</b><div id="log" class="scroll"></div></div>
        </div>
    </div>

    <div id="webhookModal" class="modal-overlay" style="display:none">
        <div class="modal">
            <h3>üîó MT5 Webhook Configuration</h3>
            <input type="text" id="webhookUrl" placeholder="http://your-railway-url.com" style="margin-bottom:10px">
            <div class="modal-buttons">
                <button onclick="testWebhook()">üß™ Test</button>
                <button onclick="saveWebhookConfig()">üíæ Save</button>
                <button onclick="closeWebhookModal()">‚úï</button>
            </div>
        </div>
    </div>

    <script>
        // VALETAX BROKER CONFIG
        const BROKER = {
            login: "641086382",
            pass: "EJam123!@",
            server: "ValetaxGlobal-Live3"
        };

        // Forex Pairs & Gold (p: pip size)
        const SYM = [
            {s:'XAU/USD', b:'XAUUSD', p:0.01, t:'metal'},
            {s:'EUR/USD', b:'EURUSD', p:0.0001, t:'major'},
            {s:'GBP/USD', b:'GBPUSD', p:0.0001, t:'major'},
            {s:'USD/JPY', b:'USDJPY', p:0.01, t:'major'},
            {s:'AUD/USD', b:'AUDUSD', p:0.0001, t:'major'},
            {s:'USD/CAD', b:'USDCAD', p:0.0001, t:'major'},
            {s:'EUR/GBP', b:'EURGBP', p:0.0001, t:'cross'},
            {s:'GBP/JPY', b:'GBPJPY', p:0.01, t:'cross'},
            {s:'EUR/JPY', b:'EURJPY', p:0.01, t:'cross'}
        ];

// ... (Keep BROKER and SYM constants as they are)

        let S = { bal: 0, pos: [], wins: 0, losses: 0 };
        let prices = {};
        let webhookConfig = { url: localStorage.getItem('wh_url') || '' };

        // FIX: Added a CORS proxy toggle to bypass browser security if needed
        const USE_PROXY = "https://cors-anywhere.herokuapp.com/"; 

        async function sendMT5Command(action, data) {
            if(!webhookConfig.url) return;
            
            // Clean the URL: ensure it starts with http/https
            let targetUrl = webhookConfig.url.trim();
            if (!targetUrl.startsWith('http')) targetUrl = 'http://' + targetUrl;

            const payload = {
                action: action,
                account: BROKER.login,
                password: BROKER.pass,
                server: BROKER.server,
                symbol: data.sym.replace('/',''),
                type: data.type,
                lots: 0.01,
                magic: 2026,
                trade_id: data.id
            };

            try {
                // Using 'no-cors' mode can help with sending, but you won't see the response body
                const res = await fetch(targetUrl, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if(res.ok || res.status === 0) { // status 0 is common for opaque responses
                    log(`üöÄ MT5 ${action} SENT: ${data.sym}`, 'g');
                    document.getElementById('webhook').textContent = 'WH:OK';
                    document.getElementById('webhook').className = 'badge on';
                } else {
                    log(`‚ùå SERVER ERROR: ${res.status}`, 'r');
                }
            } catch(e) { 
                log(`üì° WEBHOOK BLOCK: Check Browser Console (F12)`, 'y'); 
                document.getElementById('webhook').textContent = 'WH:ERR';
                document.getElementById('webhook').className = 'badge off';
            }
        }

        // Updated Test Function with better feedback
        async function testWebhook() {
            const urlInput = document.getElementById('webhookUrl').value;
            if(!urlInput) return alert("Enter URL first");
            
            log("Testing connection...", "dim");
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 5000); // 5s timeout

                const res = await fetch(urlInput, { 
                    method: 'POST', 
                    mode: 'no-cors', // Bypasses most CORS blocks for testing
                    body: JSON.stringify({test: true}) 
                });
                
                clearTimeout(id);
                log("‚úÖ Connection Path Open!", "g");
                alert("Connection attempt successful! Check Railway logs to confirm receipt.");
            } catch(e) {
                log("‚ùå Connection Blocked: " + e.message, "r");
                alert("Failed: Check if the URL is correct and the service is running.");
            }
        }

        function saveWebhookConfig() {
            const url = document.getElementById('webhookUrl').value;
            localStorage.setItem('wh_url', url);
            webhookConfig.url = url;
            closeWebhookModal();
            log("Config Saved: " + url, "b");
            // Immediate status update
            document.getElementById('webhook').textContent = 'WH:SET';
            document.getElementById('webhook').className = 'badge warn';
        }

        // ... (Keep the rest of your render and interval logic)

        setInterval(async () => {
            await fetchFXPrices();
            tradeLogic();
            render();
        }, 2000);
    </script>
</body>
</html>
